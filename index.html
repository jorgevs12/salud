<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2196F3">
    <meta name="description" content="App de salud integral con sincronizaci√≥n de dispositivos y gesti√≥n de datos">
    <meta name="keywords" content="salud, fitness, ejercicio, nutrici√≥n">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Health">
    <meta name="application-name" content="Health">
    <meta name="msapplication-TileColor" content="#2196F3">
    <meta name="msapplication-config" content="browserconfig.xml">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%232196F3' width='192' height='192'/><text x='96' y='120' font-size='100' text-anchor='middle' fill='white'>‚ù§Ô∏è</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%232196F3' width='180' height='180'/><text x='90' y='110' font-size='90' text-anchor='middle' fill='white'>‚ù§Ô∏è</text></svg>">
    <title>Health</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #000000;
            --card-bg: #111111;
            --text-main: #ffffff;
            --text-secondary: #aaaaaa;
            --border: #333333;
            --accent: #ffffff;
            --danger: #ff4444;
            --success: #44ff88;
            --warning: #ffaa44;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            padding: 20px 16px 10px;
            text-align: center;
            border-bottom: 3px solid var(--accent);
        }
        header h1 {
            font-size: 1.6rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--accent);
        }
        .main-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            padding-bottom: 90px;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .card {
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.5);
        }
        .card-title {
            font-size: 1.2rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 8px;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 14px;
        }
        .item-big, .item {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid var(--border);
        }
        .item-big {
            border: 3px solid var(--accent);
            grid-column: 1 / -1;
        }
        .item strong {
            display: block;
            font-size: 2rem;
            font-weight: 900;
            color: var(--accent);
            margin-bottom: 6px;
        }
        .item span {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }
        .progress-text {
            font-size: 0.85rem;
            margin-top: 6px;
            color: var(--text-secondary);
        }
        input, select, button {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 12px;
            background: #222222;
            color: var(--text-main);
            border: 2px solid var(--accent);
        }
        button {
            background: var(--accent);
            color: #000;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 800;
        }
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .log-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid var(--border);
        }
        .btn-delete {
            background: var(--danger);
            color: white;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .nutrient-row { margin-bottom: 20px; }
        .row-info { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .row-label { font-weight: 700; }
        .row-oms { font-size: 0.75rem; color: var(--text-secondary); display: block; }
        .row-stats.danger { color: var(--danger); }
        .progress-bar { height: 10px; background: #222222; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.6s ease; background: var(--accent); }
        .progress-fill.danger { background: var(--danger); }
        #results-dropdown {
            position: absolute;
            background: #222222;
            border: 3px solid var(--accent);
            width: calc(100% - 32px);
            max-height: 300px;
            overflow-y: auto;
            border-radius: 12px;
            z-index: 100;
            display: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.6);
            left: 16px;
            right: 16px;
        }
        .result-item {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }
        .result-item:hover { background: #333333; }
        .chart-container {
            height: 280px;
            margin: 20px 0;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-top: 2px solid var(--border);
            display: flex;
            height: 70px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.5);
        }
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
            gap: 4px;
        }
        .nav-item.active {
            color: var(--accent);
            font-weight: 800;
        }
        .nav-item svg {
            width: 24px;
            height: 24px;
        }
        @media (max-width: 480px) {
            .input-row { grid-template-columns: 1fr; }
        }

        .search-area { display: flex; flex-direction: column; gap: 12px; }
        .input-group { display: flex; gap: 10px; }
        input {
            border: 2px solid var(--accent);
            padding: 16px;
            border-radius: 12px;
            font-size: 17px;
            outline: none;
            width: 100%;
            font-weight: 600;
            background: #222222;
            color: var(--text-main);
        }
        #food-weight { width: 140px; text-align: center; }
        button {
            background: var(--accent);
            color: #000000;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-weight: 800;
            font-size: 16px;
            cursor: pointer;
        }
        
        
    </style>
</head>
<body>

    <div class="main-content">

        <!-- INICIO -->
        <div id="tab-inicio" class="section active">
            <div class="grid" id="today-summary"></div>

            <h2 class="card-title" style="margin:30px 0 16px;">Resumen Diario</h2>
            <div class="grid" id="daily-summary"></div>

            <h2 class="card-title" style="margin:30px 0 16px;">Estado de Salud</h2>
            <div class="grid" id="health-status"></div>

            <h2 class="card-title" style="margin:30px 0 16px;">√öltimas M√©tricas</h2>
            <div class="grid" id="latest-metrics"></div>
        </div>

        <!-- COMIDAS -->
        <div id="tab-comidas" class="section">
            <div class="card">
                <div class="card-title">Resumen Hoy</div>
                <div class="grid" id="quick-summary-food"></div>
            </div>

<div class="card">
    <div class="card-title">üîç Registrar Alimento</div>

    <div class="search-area">
        <div style="position: relative;">
            <!-- Input con icono de b√∫squeda y bot√≥n ‚úï para borrar -->
            <div style="position: relative; margin-bottom: 12px;">
                <input
                    type="text"
                    id="food-search"
                    placeholder="Buscar por nombre (ej: Hummus Mercadona) o c√≥digo de barras (ej: 3017620422003)"
                    autocomplete="off"
                    autofocus
                    style="width: 100%; padding: 16px 50px 16px 48px; font-size: 17px; background: #222222; color: white; border: 2px solid white; border-radius: 12px;"
                />
                <!-- Icono de b√∫squeda (izquierda) -->
                <div style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); font-size: 1.4em; color: #aaa; pointer-events: none;">
                    üîç
                </div>
                <!-- Bot√≥n ‚úï para borrar la b√∫squeda (derecha) -->
                <button
                    type="button"
                    id="clear-search-btn"
                    style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 1.6em; color: #888; cursor: pointer; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center;"
                    aria-label="Borrar b√∫squeda"
                >
                    ‚úï
                </button>
            </div>

            <!-- Peso + Bot√≥n BUSCAR -->
            <div class="input-group" style="display: flex; gap: 12px;">
                <input
                    type="number"
                    id="food-weight"
                    placeholder="Gramos"
                    value="100"
                    min="1"
                    step="1"
                    style="flex: 1; padding: 16px; text-align: center; font-size: 17px; background: #222222; color: white; border: 2px solid white; border-radius: 12px;"
                />
                <button
                    onclick="searchAPI()"
                    style="padding: 16px 28px; background: white; color: black; font-weight: 800; font-size: 16px; text-transform: uppercase; border: none; border-radius: 12px; cursor: pointer;"
                >
                    BUSCAR
                </button>
            </div>

            <!-- Dropdown con resultados -->
            <div id="results-dropdown" class="results-dropdown"></div>
        </div>

        <!-- Consejo -->
        <small style="display: block; margin-top: 12px; color: #aaa; text-align: center;">
            üí° Pega o escribe el c√≥digo de barras para agregarlo autom√°ticamente
        </small>
    </div>
</div>

<!-- SCRIPT PARA EL BOT√ìN ‚úï (BORRAR B√öSQUEDA) -->
<script>
    const foodSearch = document.getElementById('food-search');
    const clearBtn = document.getElementById('clear-search-btn');
    const dropdown = document.getElementById('results-dropdown');

    // Al pulsar el bot√≥n ‚úï: borrar el texto, cerrar dropdown y poner foco
    clearBtn.addEventListener('click', () => {
        foodSearch.value = '';
        dropdown.style.display = 'none';
        dropdown.innerHTML = '';
        foodSearch.focus(); // Para que puedas seguir escribiendo inmediatamente
    });

    // Efecto hover bonito en el bot√≥n ‚úï
    clearBtn.addEventListener('mouseenter', () => {
        clearBtn.style.background = 'rgba(255, 255, 255, 0.2)';
        clearBtn.style.color = 'white';
    });
    clearBtn.addEventListener('mouseleave', () => {
        clearBtn.style.background = 'none';
        clearBtn.style.color = '#888';
    });
</script>

            <div class="card">
                <div class="card-title">üìù Diario de Hoy</div>
                <div id="log-container-food"></div>
            </div>

            <div class="card">
                <div class="card-title">üìä Macronutrientes</div>
                <div id="macro-container"></div>
            </div>

            <div class="card">
                <div class="card-title">üß¨ Micronutrientes</div>
                <div id="micro-container"></div>
            </div>

            <div class="card" style="border:3px solid var(--accent); background:#1a1a1a;">
                <div class="card-title">Restante esta semana</div>
                <div class="grid" id="weekly-remaining-food"></div>
                <small style="display:block; text-align:center; margin-top:12px;">√öltimos 7 d√≠as</small>
            </div>
        </div>

        <!-- ENTRENO -->
        <div id="tab-entreno" class="section">
            <div class="card">
                <div class="card-title">Resumen Hoy</div>
                <div class="grid" id="quick-summary-workout"></div>
            </div>

            <div class="card">
                <div class="card-title">üèãÔ∏è Registrar Entrenamiento</div>
                <select id="workout-type">
                    <option value="cardio">Cardio</option>
                    <option value="fuerza">Fuerza</option>
                    <option value="flexibilidad">Flexibilidad</option>
                    <option value="hiit">HIIT</option>
                    <option value="otros">Otros</option>
                </select>
                <div class="input-row">
                    <input type="number" id="workout-duration" placeholder="Duraci√≥n (min)" value="30">
                    <input type="number" id="workout-calories" placeholder="Calor√≠as (opc.)">
                </div>
                <input type="number" id="steps-input" placeholder="Pasos del entrenamiento (opc.)">
                <button onclick="addWorkout()">A√ëADIR</button>
            </div>

            <div class="card">
                <div class="card-title">üìè Registrar M√©tricas</div>
                <div class="input-row">
                    <input type="number" step="0.1" id="weight-input" placeholder="Peso (kg)">
                    <input type="number" step="0.1" id="fat-input" placeholder="% Grasa">
                </div>
                <div class="input-row">
                    <input type="number" step="0.1" id="muscle-input" placeholder="% M√∫sculo">
                    <input type="number" step="0.1" id="water-input" placeholder="% Agua">
                </div>
                <button onclick="addMetrics()">GUARDAR</button>
            </div>

            <div class="card">
                <div class="card-title">üìù Entrenamientos Hoy</div>
                <div id="log-container-workout"></div>
            </div>

            <div class="card">
                <div class="card-title">üìä Evoluci√≥n</div>
                <div class="input-row" style="grid-template-columns:1fr 1fr auto;">
                    <select id="metric-filter">
                        <option value="weight">Peso (kg)</option>
                        <option value="fat">% Grasa</option>
                        <option value="muscle">% M√∫sculo</option>
                        <option value="water">% Agua</option>
                    </select>
                    <select id="time-filter">
                        <option value="week">Semana</option>
                        <option value="month">Mes</option>
                        <option value="year">A√±o</option>
                    </select>
                    <button onclick="updateCharts()">VER</button>
                </div>
                <div class="chart-container"><canvas id="metrics-chart"></canvas></div>
                <div class="chart-container"><canvas id="workouts-chart"></canvas></div>
            </div>

            <div class="card" style="border:3px solid var(--accent); background:#1a1a1a;">
                <div class="card-title">Resumen Semana</div>
                <div class="grid" id="weekly-remaining-workout"></div>
            </div>
        </div>

        <!-- AJUSTES -->
        <div id="tab-ajustes" class="section">
            <div class="card">
                <div class="card-title">Datos Personales</div>
                <div class="input-row">
                    <select id="gender">
                        <option value="male">Hombre</option>
                        <option value="female">Mujer</option>
                    </select>
                    <input type="number" id="age" placeholder="Edad">
                </div>
                <input type="number" id="height" placeholder="Altura (cm)">
            </div>

            <div class="card">
                <div class="card-title">Calor√≠as Diarias</div>
                <input type="number" id="daily-calories" placeholder="Calor√≠as objetivo">
                <small id="calorie-recommendation" style="display:block; margin-top:8px; color:var(--success);"></small>
            </div>

            <div class="card">
                <div class="card-title">Objetivos Diarios</div>
                <input type="number" id="steps-goal" placeholder="Pasos (ej: 10000)">
                <input type="number" id="training-goal" placeholder="Minutos entrenamiento (ej: 30)">
            </div>

            <div class="card">
                <div class="card-title">Objetivos a Largo Plazo</div>
                <div class="input-row">
                    <input type="number" step="0.1" id="weight-goal" placeholder="Peso objetivo (kg)">
                    <input type="number" id="weight-period" placeholder="Meses">
                </div>
                <div class="input-row">
                    <input type="number" step="0.1" id="fat-goal" placeholder="% Grasa objetivo">
                    <input type="number" id="fat-period" placeholder="Meses">
                </div>
            </div>

            <div class="card">
                <div class="card-title">Importar / Exportar Datos</div>
                <button onclick="exportData()">Exportar Datos (JSON)</button>
                <input type="file" id="import-file" accept=".json" style="margin-top:12px;">
                <button onclick="importData()">Importar Datos</button>
            </div>

            <button onclick="saveConfig()" style="margin-top:20px;">GUARDAR CONFIGURACI√ìN</button>
        </div>

    </div>

    <!-- NAVEGACI√ìN -->
<div class="bottom-nav">
    <div class="nav-item active" onclick="showTab('inicio')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        Inicio
    </div>
    <div class="nav-item" onclick="showTab('comidas')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2a10 10 0 0 1 0 20v-4a6 6 0 0 0 0-12V2z"></path>
            <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2"></path>
            <path d="M12 14v8"></path>
        </svg>
        Comidas
    </div>
    <div class="nav-item" onclick="showTab('entreno')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10 4h4"></path>
            <path d="M6 8h12"></path>
            <path d="M4 12h16"></path>
            <path d="M8 16h8"></path>
            <path d="M2 20h20"></path>
            <circle cx="8" cy="8" r="2"></circle>
            <circle cx="16" cy="12" r="2"></circle>
            <circle cx="12" cy="16" r="2"></circle>
        </svg>
        Entreno
    </div>
    <div class="nav-item" onclick="showTab('ajustes')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
        Ajustes
    </div>
</div>
    <script>
        // === NAVEGACI√ìN ===
        function showTab(tab) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        // === BASE DE DATOS Y VARIABLES GLOBALES ===
        let db;
        let userConfig = {
            dailyCalories: 2000,
            stepsGoal: 10000,
            trainingGoal: 30,
            height: 175,
            age: 30,
            gender: 'male',
            weightGoal: 0,
            weightPeriod: 0,
            fatGoal: 0,
            fatPeriod: 0
        };

        let todayMeals = [], todayWorkouts = [], allMeals = [], allWorkouts = [], allMetrics = [], latestMetrics = null;
        let metricsChart = null, workoutsChart = null;

        const request = indexedDB.open("SaludDB", 8);
        request.onupgradeneeded = e => {
            db = e.target.result;
            ['workouts', 'metrics', 'meals', 'config'].forEach(store => {
                if (!db.objectStoreNames.contains(store)) {
                    db.createObjectStore(store, { keyPath: "id" });
                }
            });
        };

        request.onsuccess = e => {
            db = e.target.result;
            loadAllData();
        };

        function loadAllData() {
            const txConfig = db.transaction("config", "readonly");
            const configStore = txConfig.objectStore("config");
            configStore.get("userConfig").onsuccess = ev => {
                if (ev.target.result) userConfig = { ...userConfig, ...ev.target.result };
                loadEntities();
                updateCalorieRecommendation();
            };
            txConfig.oncomplete = () => {
                loadEntities();
                updateCalorieRecommendation();
            };
        }

        function loadEntities() {
            const today = new Date().toISOString().split('T')[0];

            const tx = db.transaction(["meals", "workouts", "metrics"], "readonly");

            tx.objectStore("meals").getAll().onsuccess = e => {
                allMeals = e.target.result;
                todayMeals = allMeals.filter(m => m.date === today);
            };

            tx.objectStore("workouts").getAll().onsuccess = e => {
                allWorkouts = e.target.result.sort((a,b) => a.timestamp - b.timestamp);
                todayWorkouts = allWorkouts.filter(w => w.date === today);
            };

            tx.objectStore("metrics").getAll().onsuccess = e => {
                allMetrics = e.target.result.sort((a,b) => b.timestamp - a.timestamp);
                latestMetrics = allMetrics[0] || null;
                renderAll();
                updateCharts();
            };
        }

        // === IMPORT / EXPORT ===
        async function exportData() {
            const data = {
                config: userConfig,
                meals: allMeals,
                workouts: allWorkouts,
                metrics: allMetrics
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'salud_pro_data.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const fileInput = document.getElementById('import-file');
            if (!fileInput.files.length) return alert('Selecciona un archivo JSON');
            const reader = new FileReader();
            reader.onload = async e => {
                try {
                    const data = JSON.parse(e.target.result);
                    // Clear existing data
                    const stores = ['config', 'meals', 'workouts', 'metrics'];
                    for (let store of stores) {
                        const tx = db.transaction(store, "readwrite");
                        await tx.objectStore(store).clear();
                    }
                    // Import config
                    const txConfig = db.transaction("config", "readwrite");
                    txConfig.objectStore("config").put({id: "userConfig", ...data.config});
                    await txConfig.complete;
                    // Import others
                    for (let key of ['meals', 'workouts', 'metrics']) {
                        const tx = db.transaction(key, "readwrite");
                        const os = tx.objectStore(key);
                        data[key].forEach(item => os.add(item));
                        await tx.complete;
                    }
                    alert('Datos importados exitosamente');
                    loadAllData();
                } catch (err) {
                    alert('Error al importar: ' + err.message);
                }
            };
            reader.readAsText(fileInput.files[0]);
        }

        // === INICIO ===
        function renderInicio() {
            const workoutTotals = todayWorkouts.reduce((acc, w) => ({
                minutes: acc.minutes + w.duration,
                calories: acc.calories + w.calories,
                steps: acc.steps + w.steps
            }), { minutes: 0, calories: 0, steps: 0 });

            const consumed = Math.round(todayMeals.reduce((total, meal) => {
                const kcal = meal.nutriments?.['energy-kcal_100g'] || 0;
                return total + (kcal * meal.weight / 100);
            }, 0));

            const burned = Math.round(workoutTotals.calories);
            const netIntake = consumed - burned;
            const deficit = userConfig.dailyCalories - netIntake;

            // Resumen actividad
            document.getElementById('today-summary').innerHTML = `
                <div class="item-big">
                    <strong>${workoutTotals.steps.toLocaleString()}</strong>
                    <span>Pasos</span>
                    <div class="progress-text" style="color:${workoutTotals.steps >= userConfig.stepsGoal ? 'var(--success)' : 'var(--danger)'}">
                        ${workoutTotals.steps >= userConfig.stepsGoal ? '‚úì' : ''} Objetivo: ${userConfig.stepsGoal.toLocaleString()}
                    </div>
                </div>
                <div class="item-big">
                    <strong>${workoutTotals.minutes}</strong>
                    <span>Minutos entrenados</span>
                    <div class="progress-text" style="color:${workoutTotals.minutes >= userConfig.trainingGoal ? 'var(--success)' : 'var(--danger)'}">
                        ${workoutTotals.minutes >= userConfig.trainingGoal ? '‚úì' : ''} Objetivo: ${userConfig.trainingGoal} min
                    </div>
                </div>
                <div class="item-big">
                    <strong>${burned}</strong>
                    <span>Kcal quemadas</span>
                </div>
            `;

            // Resumen diario
            document.getElementById('daily-summary').innerHTML = `
                <div class="item"><strong>${consumed}</strong><span>Consumidas</span></div>
                <div class="item"><strong>${burned}</strong><span>Quemadas ej.</span></div>
                <div class="item"><strong style="color:${netIntake > userConfig.dailyCalories ? 'var(--danger)' : 'var(--success)'}">${netIntake > userConfig.dailyCalories ? '+' : ''}${netIntake - userConfig.dailyCalories}</strong><span>Balance neto</span></div>
                <div class="item"><strong style="color:${deficit >= 0 ? 'var(--success)' : 'var(--danger)'}">${deficit >= 0 ? '+' : ''}${deficit}</strong><span>${deficit >= 0 ? 'D√©ficit' : 'Super√°vit'}</span></div>
            `;

            // Estado de salud
            if (latestMetrics && latestMetrics.weight > 0) {
                const weight = latestMetrics.weight;
                const imc = (weight / Math.pow(userConfig.height / 100, 2)).toFixed(1);
                const imcStatus = imc < 18.5 ? {text:'Bajo peso', color:'var(--warning)'} :
                                 imc < 25 ? {text:'Normal', color:'var(--success)'} :
                                 imc < 30 ? {text:'Sobrepeso', color:'var(--warning)'} :
                                 {text:'Obesidad', color:'var(--danger)'};
                const ideal = userConfig.gender === 'male' ?
                    (50 + 0.91 * (userConfig.height - 152.4)).toFixed(1) :
                    (45.5 + 0.91 * (userConfig.height - 152.4)).toFixed(1);

                document.getElementById('health-status').innerHTML = `
                    <div class="item"><strong>${imc}</strong><span style="color:${imcStatus.color}">${imcStatus.text}</span><span>IMC</span></div>
                    <div class="item"><strong>${ideal} kg</strong><span>Peso ideal</span></div>
                    <div class="item"><strong>${(weight - ideal).toFixed(1)} kg</strong><span>vs Ideal</span></div>
                `;
            } else {
                document.getElementById('health-status').innerHTML = `<div class="item"><span>Registra tu peso</span><strong>‚Äî</strong></div>`;
            }

            // √öltimas m√©tricas
            const m = latestMetrics || {};
            document.getElementById('latest-metrics').innerHTML = (m.weight || m.fat || m.muscle || m.water) ? `
                ${m.weight ? `<div class="item"><strong>${m.weight.toFixed(1)}</strong><span>Peso (kg)</span></div>` : ''}
                ${m.fat ? `<div class="item"><strong>${m.fat.toFixed(1)}%</strong><span>Grasa</span></div>` : ''}
                ${m.muscle ? `<div class="item"><strong>${m.muscle.toFixed(1)}%</strong><span>M√∫sculo</span></div>` : ''}
                ${m.water ? `<div class="item"><strong>${m.water.toFixed(1)}%</strong><span>Agua</span></div>` : ''}
            ` : `<div class="item"><span>No hay m√©tricas</span><strong>‚Äî</strong></div>`;
        }

        // === COMIDAS ===
        const NUTRIENTS = {
            calories: { label: 'Calor√≠as', target: 2000, unit: 'kcal', api: 'energy-kcal_100g', isMin: true },
            protein: { label: 'Prote√≠na', target: 75, unit: 'g', api: 'proteins_100g', isMin: true },
            carbs: { label: 'Carbohidratos', target: 275, unit: 'g', api: 'carbohydrates_100g', isMin: true },
            sugars: { label: 'Az√∫cares libres', target: 50, unit: 'g', api: 'sugars_100g', isMax: true },
            fat: { label: 'Grasas totales', target: 65, unit: 'g', api: 'fat_100g', isMax: true },
            saturated: { label: 'Gr. Saturadas', target: 20, unit: 'g', api: 'saturated-fat_100g', isMax: true },
            fiber: { label: 'Fibra', target: 30, unit: 'g', api: 'fiber_100g', isMin: true },
            sodium: { label: 'Sodio', target: 2000, unit: 'mg', api: 'sodium_100g', isMax: true },
            potassium: { label: 'Potasio', target: 3500, unit: 'mg', api: 'potassium_100g', isMin: true },
            calcium: { label: 'Calcio', target: 1000, unit: 'mg', api: 'calcium_100g', isMin: true },
            magnesium: { label: 'Magnesio', target: 375, unit: 'mg', api: 'magnesium_100g', isMin: true },
            iron: { label: 'Hierro', target: 14, unit: 'mg', api: 'iron_100g', isMin: true },
            zinc: { label: 'Zinc', target: 10, unit: 'mg', api: 'zinc_100g', isMin: true },
            vitA: { label: 'Vitamina A', target: 800, unit: '¬µg', api: 'vitamin-a_100g', isMin: true },
            vitC: { label: 'Vitamina C', target: 90, unit: 'mg', api: 'vitamin-c_100g', isMin: true },
            vitD: { label: 'Vitamina D', target: 15, unit: '¬µg', api: 'vitamin-d_100g', isMin: true },
            vitE: { label: 'Vitamina E', target: 12, unit: 'mg', api: 'vitamin-e_100g', isMin: true },
            vitB6: { label: 'Vitamina B6', target: 1.5, unit: 'mg', api: 'vitamin-b6_100g', isMin: true },
            vitB12: { label: 'Vitamina B12', target: 2.4, unit: '¬µg', api: 'vitamin-b12_100g', isMin: true }
        };

        async function searchAPI() {
            const query = document.getElementById('food-search').value.trim();
            const dropdown = document.getElementById('results-dropdown');
            if (!query) return;
            dropdown.innerHTML = "<div class='result-item'>Buscando...</div>";
            dropdown.style.display = "block";
            try {
                const resp = await fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&action=process&json=1&page_size=10`);
                const data = await resp.json();
                dropdown.innerHTML = "";
                if (data.products.length === 0) {
                    dropdown.innerHTML = "<div class='result-item'>Sin resultados</div>";
                    return;
                }
                data.products.forEach(p => {
                    if (!p.product_name) return;
                    const div = document.createElement('div');
                    div.className = 'result-item';
                    div.innerHTML = `<strong>${p.product_name}</strong><br><small>${p.brands || 'Sin marca'}</small>`;
                    div.onclick = () => {
                        addMeal(p);
                        dropdown.style.display = "none";
                    };
                    dropdown.appendChild(div);
                });
            } catch (e) {
                dropdown.innerHTML = "<div class='result-item'>Error de conexi√≥n</div>";
            }
        }

function addMeal(product) {
    const weight = parseFloat(document.getElementById('food-weight').value) || 100;
    const entry = {
        id: Date.now().toString(),
        timestamp: Date.now(),
        date: new Date().toISOString().split('T')[0],
        name: product.product_name || 'Alimento',
        weight: weight,
        nutriments: product.nutriments || {}
    };

    const tx = db.transaction("meals", "readwrite");
    tx.objectStore("meals").add(entry);
    tx.oncomplete = () => {
        foodSearch.value = "";
        document.getElementById('food-weight').value = "100";
        dropdown.style.display = "none";
        dropdown.innerHTML = "";
        loadEntities();  // ‚Üê Esto provoca la actualizaci√≥n autom√°tica de todo
        foodSearch.focus();  // Bonus: vuelve a poner el foco para seguir registrando r√°pido
    };
    tx.onerror = () => alert("Error al guardar la comida");
}

        function loadWeekMeals() {
            const tx = db.transaction("meals", "readonly");
            const store = tx.objectStore("meals");
            store.getAll().onsuccess = (e) => {
                const allMeals = e.target.result;
                const today = new Date().toISOString().split('T')[0];
                foodLog = allMeals.filter(m => m.date === today);
                const start = new Date();
                start.setDate(start.getDate() - 6);
                start.setHours(0,0,0,0);
                weekMeals = allMeals.filter(m => new Date(m.date) >= start);
                renderAll();
            };
        }


        function deleteMeal(id) {
            const tx = db.transaction("meals", "readwrite");
            tx.objectStore("meals").delete(id);
            tx.oncomplete = () => loadEntities();
        }

        function calculateTotals(meals) {
            const totals = {};
            Object.keys(NUTRIENTS).forEach(k => totals[k] = 0);
            meals.forEach(m => {
                const factor = m.weight / 100;
                Object.keys(NUTRIENTS).forEach(key => {
                    const n = NUTRIENTS[key];
                    let val = m.nutriments[n.api] || 0;
                    if (['mg', '¬µg'].includes(n.unit) && n.api.includes('sodium') || n.api.includes('potassium') || n.api.includes('calcium') || n.api.includes('magnesium')) {
                        val *= n.unit === 'mg' ? 1000 : 1000000;
                    }
                    totals[key] += val * factor;
                });
            });
            return totals;
        }

        function renderComidas() {
            const todayTotals = calculateTotals(todayMeals);
            const caloriesConsumed = Math.round(todayTotals.calories);

            // Resumen r√°pido
            document.getElementById('quick-summary-food').innerHTML = `
                <div class="item"><strong>${caloriesConsumed}</strong><span>Calor√≠as</span><div class="progress-text" style="color:${caloriesConsumed <= userConfig.dailyCalories ? 'var(--success)' : 'var(--danger)'}">Objetivo: ${userConfig.dailyCalories}</div></div>
                <div class="item"><strong>${todayTotals.protein.toFixed(0)}g</strong><span>Prote√≠na</span><div class="progress-text">Meta ~75g</div></div>
            `;

            // Diario
            const logCont = document.getElementById('log-container-food');
            logCont.innerHTML = todayMeals.length ? "" : "<small>No hay registros hoy</small>";
            todayMeals.forEach(m => {
                logCont.innerHTML += `
                    <div class="log-item">
                        <span>${m.name.substring(0,40)}${m.name.length>40?'...':''} (${m.weight}g)</span>
                        <button class="btn-delete" onclick="deleteMeal('${m.id}')">BORRAR</button>
                    </div>
                `;
            });

            // Macro y Micro
            function renderNutrients(containerId, keys) {
                const cont = document.getElementById(containerId);
                cont.innerHTML = "";
                keys.forEach(key => {
                    const n = key === 'calories' ? { ...NUTRIENTS[key], target: userConfig.dailyCalories } : NUTRIENTS[key];
                    const current = todayTotals[key];
                    const percent = n.isMax ? Math.min(current / n.target * 100, 120) : Math.min(current / n.target * 100, 100);
                    const isBad = (n.isMax && current > n.target) || (!n.isMax && current < n.target * 0.9);
                    cont.innerHTML += `
                        <div class="nutrient-row">
                            <div class="row-info">
                                <div><span class="row-label">${n.label}</span><span class="row-oms">${n.isMax?'M√°x':'Meta'} ${n.target}${n.unit}/d√≠a</span></div>
                                <span class="row-stats ${isBad?'danger':''}">${current.toFixed(1)} ${n.unit}</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill ${isBad?'danger':''}" style="width:${percent}%"></div></div>
                        </div>
                    `;
                });
            }

            renderNutrients('macro-container', ['calories','protein','carbs','fat','sugars','saturated','fiber']);
            renderNutrients('micro-container', ['sodium','potassium','calcium','magnesium','iron','zinc','vitA','vitC','vitD','vitE','vitB6','vitB12']);

            // Semanal restante
            const start = new Date(); start.setDate(start.getDate() - 6);
            const weekMeals = allMeals.filter(m => new Date(m.date) >= start);
            const weekTotals = calculateTotals(weekMeals);
            const weeklyCont = document.getElementById('weekly-remaining-food');
            weeklyCont.innerHTML = "";
            ['calories','protein','fiber','sugars','saturated','sodium','potassium','vitC'].forEach(key => {
                const n = NUTRIENTS[key];
                const consumed = weekTotals[key];
                const remaining = n.target * 7 - consumed;
                const text = n.isMax ? (remaining > 0 ? `+${remaining.toFixed(0)}${n.unit}` : 'Exceso') :
                                      (remaining > 0 ? `${remaining.toFixed(0)}${n.unit}` : 'Cubierto');
                const bad = n.isMax ? remaining < 0 : remaining > n.target * 7 * 0.2;
                weeklyCont.innerHTML += `<div class="item ${bad?'danger':''}"><strong>${text}</strong><span>${n.label}</span></div>`;
            });
        }

        // === ENTRENO ===
        const WORKOUT_TYPES = {
            cardio: { label: 'Cardio', calPerMin: 10 },
            fuerza: { label: 'Fuerza', calPerMin: 8 },
            flexibilidad: { label: 'Flexibilidad', calPerMin: 5 },
            hiit: { label: 'HIIT', calPerMin: 12 },
            otros: { label: 'Otros', calPerMin: 7 }
        };

        function addWorkout() {
            const type = document.getElementById('workout-type').value;
            const duration = parseFloat(document.getElementById('workout-duration').value) || 0;
            let calories = parseFloat(document.getElementById('workout-calories').value) || 0;
            const steps = parseFloat(document.getElementById('steps-input').value) || 0;

            if (calories === 0 && duration > 0) {
                calories = duration * WORKOUT_TYPES[type].calPerMin + steps * 0.04;
            }

            const entry = {
                id: Date.now().toString(),
                timestamp: Date.now(),
                date: new Date().toISOString().split('T')[0],
                type, duration, calories: Math.round(calories), steps
            };

            const tx = db.transaction("workouts", "readwrite");
            tx.objectStore("workouts").add(entry);
            tx.oncomplete = () => {
                document.getElementById('workout-duration').value = "";
                document.getElementById('workout-calories').value = "";
                document.getElementById('steps-input').value = "";
                loadEntities();
            };
        }

        function addMetrics() {
            const weight = parseFloat(document.getElementById('weight-input').value) || 0;
            const fat = parseFloat(document.getElementById('fat-input').value) || 0;
            const muscle = parseFloat(document.getElementById('muscle-input').value) || 0;
            const water = parseFloat(document.getElementById('water-input').value) || 0;

            if ([weight, fat, muscle, water].every(v => v === 0)) return;

            const entry = {
                id: Date.now().toString(),
                timestamp: Date.now(),
                date: new Date().toISOString().split('T')[0],
                weight, fat, muscle, water
            };

            const tx = db.transaction("metrics", "readwrite");
            tx.objectStore("metrics").add(entry);
            tx.oncomplete = () => {
                ['weight','fat','muscle','water'].forEach(id => document.getElementById(id + '-input').value = "");
                loadEntities();
            };
        }

        function deleteWorkout(id) {
            const tx = db.transaction("workouts", "readwrite");
            tx.objectStore("workouts").delete(id);
            tx.oncomplete = () => loadEntities();
        }

        function renderEntreno() {
            const totals = todayWorkouts.reduce((acc, w) => ({
                duration: acc.duration + w.duration,
                calories: acc.calories + w.calories,
                steps: acc.steps + w.steps
            }), { duration: 0, calories: 0, steps: 0 });

            document.getElementById('quick-summary-workout').innerHTML = `
                <div class="item"><strong>${totals.duration}</strong><span>Minutos</span><div class="progress-text" style="color:${totals.duration >= userConfig.trainingGoal ? 'var(--success)' : 'var(--danger)'}">Objetivo: ${userConfig.trainingGoal}</div></div>
                <div class="item"><strong>${Math.round(totals.calories)}</strong><span>Kcal quemadas</span></div>
                <div class="item"><strong>${totals.steps.toLocaleString()}</strong><span>Pasos</span><div class="progress-text" style="color:${totals.steps >= userConfig.stepsGoal ? 'var(--success)' : 'var(--danger)'}">Objetivo: ${userConfig.stepsGoal}</div></div>
            `;

            const logCont = document.getElementById('log-container-workout');
            logCont.innerHTML = todayWorkouts.length ? "" : "<small>Sin entrenamientos hoy</small>";
            todayWorkouts.forEach(w => {
                logCont.innerHTML += `
                    <div class="log-item">
                        <span>${WORKOUT_TYPES[w.type].label}<br><small>${w.duration} min ‚Ä¢ ${w.calories} kcal ‚Ä¢ ${w.steps} pasos</small></span>
                        <button class="btn-delete" onclick="deleteWorkout('${w.id}')">BORRAR</button>
                    </div>
                `;
            });

            // Resumen semanal
            const last7 = allWorkouts.filter(w => {
                const d = new Date(w.date);
                const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7);
                return d >= weekAgo;
            });
            const weekTotals = last7.reduce((acc, w) => ({
                duration: acc.duration + w.duration,
                calories: acc.calories + w.calories,
                steps: acc.steps + w.steps
            }), { duration: 0, calories: 0, steps: 0 });
            const days = [...new Set(last7.map(w => w.date))].length || 1;
            document.getElementById('weekly-remaining-workout').innerHTML = `
                <div class="item"><strong>${Math.round(weekTotals.duration / days)}</strong><span>Min/d√≠a promedio</span></div>
                <div class="item"><strong>${Math.round(weekTotals.calories)}</strong><span>Kcal totales</span></div>
                <div class="item"><strong>${Math.round(weekTotals.steps / days).toLocaleString()}</strong><span>Pasos/d√≠a promedio</span></div>
            `;
        }

        function updateCharts() {
            const metric = document.getElementById('metric-filter').value;
            const time = document.getElementById('time-filter').value;

            let cutoff = new Date();
            if (time === 'week') cutoff.setDate(cutoff.getDate() - 7);
            else if (time === 'month') cutoff.setDate(cutoff.getDate() - 30);
            else cutoff.setFullYear(cutoff.getFullYear() - 1);

            const filteredMetrics = allMetrics.filter(m => new Date(m.date) >= cutoff);
            const filteredWorkouts = allWorkouts.filter(w => new Date(w.date) >= cutoff);

            // M√©tricas corporales
            const dates = [...new Set(filteredMetrics.map(m => m.date))].sort();
            const values = dates.map(d => {
                const e = filteredMetrics.find(m => m.date === d);
                return e && e[metric] > 0 ? e[metric] : null;
            }).filter(v => v !== null);

            if (metricsChart) metricsChart.destroy();
            metricsChart = new Chart(document.getElementById('metrics-chart'), {
                type: 'line',
                data: { labels: dates, datasets: [{ label: metric, data: values, borderColor: 'white', tension: 0.2, fill: true }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#aaa' } }, y: { ticks: { color: '#aaa' } } } }
            });

            // Calor√≠as por d√≠a
            const workoutDates = [...new Set(filteredWorkouts.map(w => w.date))].sort();
            const caloriesPerDay = workoutDates.map(d => filteredWorkouts.filter(w => w.date === d).reduce((s, w) => s + w.calories, 0));

            if (workoutsChart) workoutsChart.destroy();
            workoutsChart = new Chart(document.getElementById('workouts-chart'), {
                type: 'bar',
                data: { labels: workoutDates, datasets: [{ label: 'Kcal', data: caloriesPerDay, backgroundColor: 'white' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#aaa' } }, y: { beginAtZero: true, ticks: { color: '#aaa' } } } }
            });
        }

        // === AJUSTES ===
        function updateCalorieRecommendation() {
            const weight = latestMetrics ? latestMetrics.weight : 0;
            const height = parseFloat(document.getElementById('height').value) || userConfig.height;
            const age = parseFloat(document.getElementById('age').value) || userConfig.age;
            const gender = document.getElementById('gender').value;

            if (weight > 0 && height > 0 && age > 0) {
                const bmr = gender === 'male' ?
                    10 * weight + 6.25 * height - 5 * age + 5 :
                    10 * weight + 6.25 * height - 5 * age - 161;
                const recommended = Math.round(bmr * 1.55); // actividad moderada
                document.getElementById('calorie-recommendation').textContent = `Recomendado: ${recommended} kcal (basado en ${weight} kg)`;
            } else {
                document.getElementById('calorie-recommendation').textContent = 'Registra peso, altura y edad para recomendaci√≥n';
            }
        }

        document.getElementById('height').addEventListener('input', updateCalorieRecommendation);
        document.getElementById('age').addEventListener('input', updateCalorieRecommendation);
        document.getElementById('gender').addEventListener('change', updateCalorieRecommendation);

        function saveConfig() {
            userConfig.gender = document.getElementById('gender').value;
            userConfig.age = parseFloat(document.getElementById('age').value) || 30;
            userConfig.height = parseFloat(document.getElementById('height').value) || 175;
            userConfig.dailyCalories = parseFloat(document.getElementById('daily-calories').value) || 2000;
            userConfig.stepsGoal = parseFloat(document.getElementById('steps-goal').value) || 10000;
            userConfig.trainingGoal = parseFloat(document.getElementById('training-goal').value) || 30;
            userConfig.weightGoal = parseFloat(document.getElementById('weight-goal').value) || 0;
            userConfig.weightPeriod = parseFloat(document.getElementById('weight-period').value) || 0;
            userConfig.fatGoal = parseFloat(document.getElementById('fat-goal').value) || 0;
            userConfig.fatPeriod = parseFloat(document.getElementById('fat-period').value) || 0;

            const tx = db.transaction("config", "readwrite");
            tx.objectStore("config").put({id: "userConfig", ...userConfig});
            tx.oncomplete = () => {
                alert('Configuraci√≥n guardada');
                loadEntities();
            };
        }

        // === RENDER GLOBAL ===
        function renderAll() {
            renderInicio();
            renderComidas();
            renderEntreno();
        }

        // ========================================
        // REGISTRAR SERVICE WORKER - PWA
        // ========================================
        // REGISTRAR SERVICE WORKER - PWA
        // ========================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registrado:', registration);
                        console.log('üì± Scope:', registration.scope);
                    })
                    .catch(error => {
                        console.warn('‚ùå Error al registrar Service Worker:', error);
                    });
            });
        }

        // Debug: Verificar manifest.json
        console.log('üîç Verificando PWA...');
        fetch('manifest.json')
            .then(r => r.json())
            .then(manifest => {
                console.log('‚úÖ Manifest.json cargado:', manifest);
            })
            .catch(e => {
                console.error('‚ùå Error cargando manifest:', e);
            });

    </script>
</body>
</html>
